version: '3'

includes:
  common: ../Taskfile.yml

tasks:
  build:
    desc: Builds the application for Linux
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
      - task: common:generate:icons
    cmds:
      - go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.BINARY_NAME}}
    vars:
      LD_FLAGS: '-X github.com/loomi-labs/arco/backend/app/types.Version=v{{.VERSION}}'
#      TODO: add -race back once it is fixed in Wails
#      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -buildvcs=false -ldflags="-w -s {{.LD_FLAGS}}"{{else}}-race -tags assert -buildvcs=false -gcflags=all="-l" -ldflags="{{.LD_FLAGS}}"{{end}}'
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -buildvcs=false -ldflags="-w -s {{.LD_FLAGS}}"{{else}} -tags assert -buildvcs=false -gcflags=all="-l" -ldflags="{{.LD_FLAGS}}"{{end}}'
    env:
      GOOS: linux
      CGO_ENABLED: 1
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'

  package:
    desc: Packages a production build of the application for Linux
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - task: create:deb
      - task: create:rpm
      - task: create:aur

  create:appimage:
    desc: Creates an AppImage
    dir: build/linux/appimage
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
      - task: generate:dotdesktop
    cmds:
      - cp {{.APP_BINARY}} {{.BINARY_NAME}}
      - cp ../../appicon-light.png appicon-light.png
      - go tool wails3 generate appimage -binary {{.BINARY_NAME}} -icon {{.ICON}} -desktopfile {{.DESKTOP_FILE}} -outputdir {{.OUTPUT_DIR}} -builddir {{.ROOT_DIR}}/build/linux/appimage/build
    vars:
      APP_BINARY: '../../../bin/{{.BINARY_NAME}}'
      ICON: '../../appicon-light.png'
      DESKTOP_FILE: '../{{.BINARY_NAME}}.desktop'
      OUTPUT_DIR: '../../../bin'

  create:deb:
    desc: Creates a deb package
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - task: generate:dotdesktop
      - task: generate:deb

  create:rpm:
    desc: Creates a rpm package
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - task: generate:dotdesktop
      - task: generate:rpm

  create:aur:
    desc: Creates a arch linux packager package
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - task: generate:dotdesktop
      - task: generate:aur

  generate:deb:
    desc: Creates a deb package
    cmds:
      - go tool wails3 tool package -name {{.BINARY_NAME}} -format deb -config ./build/linux/nfpm/nfpm.yaml -out {{.ROOT_DIR}}/bin
      - ls -la {{.ROOT_DIR}}/bin/
      - sh -c 'mv {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}_*.deb {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}_amd64.deb'
    env:
      VERSION: '{{.VERSION}}'

  generate:rpm:
    desc: Creates a rpm package
    cmds:
      - go tool wails3 tool package -name {{.BINARY_NAME}} -format rpm -config ./build/linux/nfpm/nfpm.yaml -out {{.ROOT_DIR}}/bin
      - sh -c 'mv {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}-*.rpm {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}.x86_64.rpm'
    env:
      VERSION: '{{.VERSION}}'

  generate:aur:
    desc: Creates a arch linux packager package
    cmds:
      - go tool wails3 tool package -name {{.BINARY_NAME}} -format archlinux -config ./build/linux/nfpm/nfpm.yaml -out {{.ROOT_DIR}}/bin
      - sh -c 'mv {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}-*.pkg.tar.zst {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}-x86_64.pkg.tar.zst'
    env:
      VERSION: '{{.VERSION}}'

  generate:dotdesktop:
    desc: Generates a `.desktop` file
    dir: build
    cmds:
      - mkdir -p {{.ROOT_DIR}}/build/linux/appimage
      - go tool wails3 generate .desktop -name "{{.BINARY_NAME}}" -exec "{{.BINARY_NAME}}" -icon "appicon-light" -outputfile {{.ROOT_DIR}}/build/linux/{{.BINARY_NAME}}.desktop -categories "Utility;" -keywords "backup;borg;borgbackup;" -comment "A modern backup application based on BorgBackup"
      - sed -i 's/^Name={{.BINARY_NAME}}$/Name={{.APP_NAME}}/' {{.ROOT_DIR}}/build/linux/{{.BINARY_NAME}}.desktop
    vars:
      APP_NAME: '{{.APP_NAME}}'
      EXEC: '{{.APP_NAME}}'
      ICON: 'appicon-light'
      CATEGORIES: 'Development;'
      OUTPUTFILE: '{{.ROOT_DIR}}/build/linux/{{.APP_NAME}}.desktop'

  run:
    cmds:
      - '{{.BIN_DIR}}/{{.BINARY_NAME}}'
