name: Build

on:
  workflow_call:

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    outputs:
      create-release-pr-output: ${{ steps.release.outputs.release_created }}
    steps:
      # Create release PR
      - uses: googleapis/release-please-action@v4
        with:
          release-type: go
          skip-github-release: true

  build:
    needs: create-release-pr
    if: ${{ needs.create-release-pr.outputs.create-release-pr-output }}
    strategy:
      fail-fast: false
      matrix:
        # Build Arco for Linux and MacOS
        build: [
          { zip-name: arco-linux.zip, platform: linux/amd64, os: ubuntu-latest },
          { zip-name: arco-macos.zip, platform: darwin/universal, os: macos-latest }
        ]
#    outputs:
#      output_ubuntu-latest: ${{ steps.gen_output.outputs.output_ubuntu-latest }}
#      output_macos-latest: ${{ steps.gen_output.outputs.output_macos-latest }}
    runs-on: ${{ matrix.build.os }}
    steps:
      # Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4
      # Setup pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      # Build Arco with Wails
      - name: Build Arco
        uses: dAppServer/wails-build-action@v2.2
        with:
          node-version: 22
          build-name: arco
          build-platform: ${{ matrix.build.platform }}
          package: false
#      - name: Debug show all files
#        run: ls -la ./build/bin/
      # Compress build artifact (only for Linux)
      - name: Compress build artifact
        if: ${{ matrix.build.os == 'ubuntu-latest' }}
        run: zip -r ./build/bin/${{ matrix.build.zip-name }} ./build/bin/arco
      # Rename build artifact (only for MacOS)
      - name: Rename build artifact
        if: ${{ matrix.build.os == 'macos-latest' }}
        run: mv ./build/bin/arco.app.zip ./build/bin/${{ matrix.build.zip-name }}
      # Upload build assets
      - uses: actions/upload-artifact@v4
        id: upload
        with:
          name: build-asset-${{runner.os}}
          path: |
            */bin/
            *\bin\*

      # Generate upload output
#      - name: Generate upload output
#        id: gen_output
#        run: |
#          os="${{ matrix.build.os }}"
#          upload="${{ steps.upload.outputs.artifact-id }}"
#          echo "output_${os}=${upload}" >> "$GITHUB_OUTPUT"

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # Create release PR
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go
          skip-github-pull-request: true
      # Download release artifact
      - uses: actions/download-artifact@v4
        if: ${{ steps.release.outputs.release_created }}
        with:
          path: build-asset
          pattern: build-asset-*
#          pattern: Wails Build*
      # Debug show all files
#      - name: Debug show all files
#        run: ls -la ./build-asset/
      # Upload release artifact
      - name: Upload release artifact if release created
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        run: gh release upload ${{ steps.release.outputs.tag_name }} ./build-asset/arco-linux.zip ./build-asset/arco-macos.zip
        run: gh release upload ${{ steps.release.outputs.tag_name }} ./build-asset/arco-linux.zip ./build-asset/arco-macos.zip