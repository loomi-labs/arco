name: Build

on:
  workflow_call:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        # Build Arco for Linux and MacOS
        build: [
          { zip-name: arco-linux.zip, platform: linux/amd64, os: ubuntu-latest },
          { zip-name: arco-macos.zip, platform: darwin/universal, os: macos-latest }
        ]
    runs-on: ${{ matrix.build.os }}
    steps:
      # Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4
      # Setup pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      # Build Arco with Wails
      - name: Build Arco
        uses: dAppServer/wails-build-action@v2.2
        with:
          node-version: 22
          build-name: arco
          build-platform: ${{ matrix.build.platform }}
          package: false
      # Create release PR
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go
      - name: Debug show all files
        run: ls -la ./build/bin/
      # Compress build artifact (only for Linux)
      - name: Compress build artifact
        if: ${{ matrix.build.os == 'ubuntu-latest' }}
        run: zip -r ./build/bin/${{ matrix.build.zip-name }} ./build/bin/arco
      # Rename build artifact (only for MacOS)
      - name: Rename build artifact
        if: ${{ matrix.build.os == 'macos-latest' }}
        run: mv ./build/bin/arco.app.zip ./build/bin/${{ matrix.build.zip-name }}
      # Upload release artifact
      - name: Upload release artifact
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.release.outputs.tag_name }} ./build/bin/${{ matrix.build.zip-name }}